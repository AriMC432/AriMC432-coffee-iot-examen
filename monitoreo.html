<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Monitoreo - Coffee IoT</title>
  <link rel="icon" type="image/x-icon" href="assets/img/favicon.ico">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/estilos.css" />
</head>

<body class="bg-cafe">
  <nav class="navbar navbar-expand-lg navbar-dark barra-cafe">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html">Coffee IoT</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div id="nav" class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto gap-2">
          <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="admin.html">Admin</a></li>
          <li class="nav-item"><a class="nav-link" href="control.html">Control</a></li>
          <li class="nav-item"><a class="nav-link active" href="monitoreo.html">Monitoreo</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="py-5">
    <div class="container">
      <div class="row g-4">

        <!-- ESTATUS EN VIVO -->
        <div class="col-lg-4">
          <div class="tarjeta-vidrio p-3 h-100">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="text-white mb-0">Estatus en vivo (activas)</h5>
              <span id="badgeLive" class="badge text-bg-info">Auto: 2s</span>
            </div>

            <!-- AQUÍ SE PINTAN TODAS LAS CAFETERÍAS ACTIVAS -->
            <div id="liveContainer" class="d-grid gap-3">
              <div class="text-white-50 small">Cargando...</div>
            </div>

            <hr class="border-light opacity-25">

            <div class="d-flex gap-2">
              <button class="btn btn-light fw-semibold" id="btnRefrescar" type="button">Refrescar</button>
              <span id="estadoConexion" class="badge rounded-pill text-bg-warning align-self-center">Conectando...</span>
            </div>
          </div>
        </div>

        <!-- HISTORIAL -->
        <div class="col-lg-8">
          <div class="tarjeta-vidrio p-3">
            <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center">
              <h5 class="text-white mb-0">Historial de eventos</h5>

              <div class="d-flex flex-wrap gap-2 align-items-center">
                <label class="text-white-50 small mb-0">Cafetería:</label>
                <select id="filtroCafeteria" class="form-select form-select-sm" style="width: 220px;">
                  <option value="todas">Todas</option>
                </select>

                <label class="text-white-50 small mb-0 ms-1">Dispositivo:</label>
                <select id="filtroDisp" class="form-select form-select-sm" style="width: 200px;">
                  <option value="todos">Todos</option>
                  <option value="cafetera">Cafetera</option>
                  <option value="crepera">Crepera</option>
                  <option value="molino">Molino</option>
                  <option value="admin">Admin</option>
                </select>
              </div>
            </div>

            <div class="table-responsive mt-3">
              <table class="table table-sm table-dark table-hover align-middle mb-0">
                <thead>
                  <tr>
                    <th>Fecha/Hora</th>
                    <th>Dispositivo</th>
                    <th>Estado</th>
                    <th>Mensaje</th>
                    <th>Alerta</th>
                  </tr>
                </thead>
                <tbody id="tbodyHist">
                  <tr><td colspan="5" class="text-white-50">Cargando historial...</td></tr>
                </tbody>
              </table>
            </div>

            <div class="text-white-50 small mt-2 d-flex justify-content-between flex-wrap gap-2">
              <div>API: <span id="apiBase"></span></div>
              <div class="text-white-50">Mostrando: <span id="lblMostrando">10</span> últimos</div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </main>

  <footer class="footer-cafe py-4 mt-auto">
    <div class="container text-center">
      <div class="text-white-50 small">
        <div>Coffee IoT · Panel de control y monitoreo · 2026</div>
        <div>Autor: Ariana Muñoz Castillo</div>
        <div>
          <a href="https://www.linkedin.com/in/ariana-muñoz-castillo-0a817b381"
             target="_blank"
             class="text-white text-decoration-none">
            Linkedin: www.linkedin.com/in/ariana-muñoz-castillo-0a817b381
          </a>
        </div>
      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
document.addEventListener("DOMContentLoaded", () => {

  const API_BASE = "https://698a18b7c04d974bc6a1598e.mockapi.io/api/v1";
  const API_CAF  = `${API_BASE}/cafeterias`;
  const API_HIST = `${API_BASE}/historial_estados`;

  const $apiBase = document.getElementById("apiBase");
  const $estadoConexion = document.getElementById("estadoConexion");
  const $tbodyHist = document.getElementById("tbodyHist");
  const $filtroDisp = document.getElementById("filtroDisp");
  const $filtroCafeteria = document.getElementById("filtroCafeteria");
  const $lblMostrando = document.getElementById("lblMostrando");
  const $liveContainer = document.getElementById("liveContainer");

  if ($apiBase) $apiBase.textContent = API_BASE;

  const LS_KEY_CAF  = "monitoreo_filtro_cafeteria";
  const LS_KEY_DISP = "monitoreo_filtro_dispositivo";

  function setConexion(ok){
    if(!$estadoConexion) return;
    if(ok){
      $estadoConexion.textContent = "Conectado";
      $estadoConexion.className = "badge rounded-pill text-bg-success align-self-center";
    }else{
      $estadoConexion.textContent = "Error API";
      $estadoConexion.className = "badge rounded-pill text-bg-danger align-self-center";
    }
  }

  function fechaSeguraISO(h){
    return h?.fecha_hora || h?.createdAt || h?.updatedAt || "";
  }
  function fechaSeguraMs(h){
    const iso = fechaSeguraISO(h);
    const t = iso ? new Date(iso).getTime() : 0;
    return Number.isFinite(t) ? t : 0;
  }
  function horaCortaPorHist(h){
    const iso = fechaSeguraISO(h);
    if(!iso) return "—";
    try { return new Date(iso).toLocaleString(); } catch { return "—"; }
  }

  // ====== filtros persistentes ======
  function guardarFiltros(){
    try{
      localStorage.setItem(LS_KEY_CAF,  $filtroCafeteria?.value ?? "todas");
      localStorage.setItem(LS_KEY_DISP, $filtroDisp?.value ?? "todos");
    }catch{}
  }
  function restaurarFiltros(){
    try{
      const caf = localStorage.getItem(LS_KEY_CAF);
      const disp = localStorage.getItem(LS_KEY_DISP);
      if($filtroCafeteria && caf) $filtroCafeteria.value = caf;
      if($filtroDisp && disp) $filtroDisp.value = disp;
    }catch{}
  }

  // ====== combo cafeterías ======
  async function cargarComboCafeterias(){
    try{
      const r = await fetch(API_CAF);
      if(!r.ok) throw new Error("No se pudo leer cafeterias");
      const lista = await r.json();
      const arr = Array.isArray(lista) ? lista : [];

      const selected = ($filtroCafeteria?.value) || "todas";

      $filtroCafeteria.innerHTML =
        `<option value="todas">Todas</option>` +
        arr.map(c => `<option value="${c.id}">${c.nombre || ("Cafetería " + c.id)}</option>`).join("");

      if(selected) $filtroCafeteria.value = selected;

      if($filtroCafeteria.value !== selected && selected !== "todas"){
        $filtroCafeteria.value = "todas";
        guardarFiltros();
      }
    }catch(e){
      console.error(e);
    }
  }

  // ====== helpers estatus ======
  function estadoCafeteraBonito(caf){
    const v = caf?.variables || {};
    const map = [
      ["purga_on","Purgación de lanceta"],
      ["lanceta_on","Lanceta"],
      ["extraccion_on","Extracción del café"],
      ["filtro_on","Filtro de café"],
      ["agua_on","Salida de agua caliente"],
    ];
    const activos = map.filter(([k]) => !!v[k]).map(([,l]) => l);
    return activos.length ? `encendida: ${activos.join(", ")}` : "apagada";
  }
  function estadoCreperaBonito(cre){
    const t = Number(cre?.variables?.temperatura_c ?? 0);
    if(t === 0) return "apagada — 0°C";
    return `${cre.estado} — ${t}°C`;
  }
  function estadoMolinoBonito(mol){
    return mol.estado || `molienda_${mol?.variables?.molienda_tipo || "medio"}`;
  }

  function liveCardHTML(c){
    const caf = c.dispositivos?.cafetera;
    const cre = c.dispositivos?.crepera;
    const mol = c.dispositivos?.molino;

    const cafTxt = caf ? `${caf.nombre}: ${estadoCafeteraBonito(caf)}` : "—";
    const creTxt = cre ? `${cre.nombre}: ${estadoCreperaBonito(cre)}` : "—";
    const molTxt = mol ? `${mol.nombre}: ${estadoMolinoBonito(mol)}` : "—";

    const alCaf = caf?.alerta_activa ? `⚠ ${caf?.mensaje_alerta || "Alerta activa"}` : "";
    const alCre = cre?.alerta_activa ? `⚠ ${cre?.mensaje_alerta || "Alerta activa"}` : "";
    const alMol = mol?.alerta_activa ? `⚠ ${mol?.mensaje_alerta || "Alerta activa"}` : "";

    return `
      <div class="p-2 rounded-4" style="border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.18);">
        <div class="d-flex justify-content-between align-items-center">
          <div class="text-white fw-semibold">${c.nombre || ("Cafetería " + c.id)}</div>
          <span class="badge text-bg-success">Activa</span>
        </div>

        <div class="mt-2">
          <div class="text-white-50 small">Cafetera</div>
          <div class="text-white fw-semibold small">${cafTxt}</div>
          <div class="text-warning small">${alCaf}</div>
        </div>

        <div class="mt-2">
          <div class="text-white-50 small">Crepera</div>
          <div class="text-white fw-semibold small">${creTxt}</div>
          <div class="text-warning small">${alCre}</div>
        </div>

        <div class="mt-2">
          <div class="text-white-50 small">Molino</div>
          <div class="text-white fw-semibold small">${molTxt}</div>
          <div class="text-warning small">${alMol}</div>
        </div>
      </div>
    `;
  }

  // ====== LIVE: TODAS ACTIVAS ======
  async function cargarLive(){
    try{
      const r = await fetch(API_CAF);
      if(!r.ok) throw new Error("No se pudo leer cafeterias");
      const lista = await r.json();
      const arr = Array.isArray(lista) ? lista : [];

      // si el filtro está en una cafetería específica, mostramos SOLO ESA (si está activa)
      const cafId = $filtroCafeteria?.value || "todas";
      let activas = arr.filter(x => x && x.activa === true);

      if(cafId !== "todas"){
        activas = activas.filter(x => String(x.id) === String(cafId));
      }

      if(!$liveContainer) return;

      if(!activas.length){
        $liveContainer.innerHTML = `<div class="text-white-50 small">No hay cafeterías activas en este momento.</div>`;
        setConexion(true);
        return;
      }

      $liveContainer.innerHTML = activas.map(liveCardHTML).join("");

      setConexion(true);
    }catch(e){
      console.error(e);
      setConexion(false);
      if($liveContainer){
        $liveContainer.innerHTML = `<div class="text-white-50 small">Error cargando estatus en vivo.</div>`;
      }
    }
  }

  // ====== HISTORIAL ======
  function filaHist(h){
    const disp = (h.dispositivo_nombre || h.dispositivo_tipo || "—").toString();
    const caf = (h.cafeteria_nombre || "").toString();
    const msg = (h.mensaje || "").trim();

    const alertaTxt = h.alerta_activa ? "Sí" : "No";
    const msgHtml = msg ? (h.alerta_activa ? `⚠ ${msg}` : msg) : "";

    return `
      <tr>
        <td class="text-white-50">${horaCortaPorHist(h)}</td>
        <td class="text-white">
          ${disp}
          <div class="text-white-50 small">${caf}</div>
        </td>
        <td class="text-white fw-semibold">${h.estado || "—"}</td>
        <td class="${h.alerta_activa ? "text-warning small" : "text-white-50 small"}">${msgHtml}</td>
        <td class="${h.alerta_activa ? "text-warning fw-semibold" : "text-white-50"}">${alertaTxt}</td>
      </tr>
    `;
  }

  async function cargarHistorial(){
    try{
      const r = await fetch(API_HIST);
      if(!r.ok) throw new Error("No se pudo leer historial_estados");
      let data = await r.json();
      data = Array.isArray(data) ? data : [];

      data.sort((a,b) => fechaSeguraMs(b) - fechaSeguraMs(a));

      const cafId = $filtroCafeteria?.value || "todas";
      const dispTipo = $filtroDisp?.value || "todos";

      if(cafId !== "todas"){
        data = data.filter(x => String(x.cafeteria_id || "") === String(cafId));
      }

      if(dispTipo !== "todos"){
        data = data.filter(x => String(x.dispositivo_tipo || "").toLowerCase() === dispTipo);
      }

      data = data.slice(0, 10);
      if($lblMostrando) $lblMostrando.textContent = String(data.length);

      if(!data.length){
        $tbodyHist.innerHTML = `<tr><td colspan="5" class="text-white-50">Sin eventos.</td></tr>`;
        return;
      }

      $tbodyHist.innerHTML = data.map(filaHist).join("");
    }catch(e){
      console.error(e);
      $tbodyHist.innerHTML = `<tr><td colspan="5" class="text-white-50">Error cargando historial.</td></tr>`;
    }
  }

  async function cargarTodo(){
    await Promise.all([cargarLive(), cargarHistorial()]);
  }

  document.getElementById("btnRefrescar")?.addEventListener("click", cargarTodo);

  $filtroCafeteria?.addEventListener("change", async ()=>{
    guardarFiltros();
    await cargarTodo();
  });

  $filtroDisp?.addEventListener("change", async ()=>{
    guardarFiltros();
    await cargarHistorial();
  });

  (async function init(){
    restaurarFiltros();
    await cargarComboCafeterias();
    restaurarFiltros();
    await cargarTodo();
    setInterval(cargarTodo, 2000);
  })();

});
  </script>
</body>
</html>